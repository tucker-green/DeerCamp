rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user's membership for a specific club
    function getMembership(clubId) {
      return exists(/databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid));
    }

    // Get user's role in a specific club
    function getClubRole(clubId) {
      let membershipPath = /databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid);
      return exists(membershipPath) ? get(membershipPath).data.role : null;
    }

    // Check if user is a member of the club (active or pending)
    function isMember(clubId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid));
    }

    // Check if user has owner or manager role in the club
    function isManagerOrOwner(clubId) {
      let membershipPath = /databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid);
      return isAuthenticated() &&
        exists(membershipPath) &&
        get(membershipPath).data.role in ['owner', 'manager'];
    }

    // Check if user is owner of the club
    function isClubOwner(clubId) {
      let membershipPath = /databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid);
      return isAuthenticated() &&
        exists(membershipPath) &&
        get(membershipPath).data.role == 'owner';
    }

    // ===== USERS COLLECTION =====
    // Users can read any profile (for member discovery, invites, etc.)
    // Users can create their own profile
    // Users can only update their own profile (basic fields)
    // ClubIds array is managed by club join/leave operations
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId &&
        // Prevent users from directly modifying clubIds or activeClubId
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['clubIds', 'activeClubId']) ||
         request.resource.data.clubIds == resource.data.clubIds);
      allow delete: if false; // Users cannot delete themselves
    }

    // ===== CLUBS COLLECTION =====
    // Anyone can read public clubs (for discovery)
    // Members can read their own clubs
    // Anyone can create a club (they become owner)
    // Only owner can update or delete
    match /clubs/{clubId} {
      allow read: if resource.data.isPublic == true || isMember(clubId);
      allow create: if isAuthenticated() &&
        request.resource.data.ownerId == request.auth.uid;
      allow update: if isClubOwner(clubId);
      allow delete: if isClubOwner(clubId);
    }

    // ===== CLUB MEMBERSHIPS COLLECTION =====
    // Members can read memberships for their clubs
    // System creates memberships (via cloud functions or app logic)
    // Managers can update member roles/status
    // Owners can delete memberships (remove members)
    match /clubMemberships/{membershipId} {
      // Allow reading own memberships or memberships from clubs you're in
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isMember(resource.data.clubId));

      // Can create if: creating own membership OR manager adding member OR creating owner membership for your club
      allow create: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid ||
         isManagerOrOwner(request.resource.data.clubId) ||
         (request.resource.data.role == 'owner' &&
          get(/databases/$(database)/documents/clubs/$(request.resource.data.clubId)).data.ownerId == request.auth.uid));

      // Managers can update (change roles, status)
      // Users can update their own basic fields (not role/status)
      allow update: if isManagerOrOwner(resource.data.clubId) ||
        (request.auth.uid == resource.data.userId &&
         request.resource.data.role == resource.data.role &&
         request.resource.data.membershipStatus == resource.data.membershipStatus);

      // Only managers can remove members
      allow delete: if isManagerOrOwner(resource.data.clubId);
    }

    // ===== CLUB JOIN REQUESTS COLLECTION =====
    // Users can read their own requests
    // Managers can read requests for their club
    // Users can create requests for public clubs
    // Managers can update (approve/reject)
    // Users can cancel their own requests
    match /clubJoinRequests/{requestId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isManagerOrOwner(resource.data.clubId) ||
        (request.auth.uid == resource.data.userId &&
         request.resource.data.status == 'cancelled');

      allow delete: if isManagerOrOwner(resource.data.clubId);
    }

    // ===== STANDS COLLECTION =====
    // Members can read stands from their clubs
    // Managers can create/update/delete stands
    match /stands/{standId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    // ===== BOOKINGS COLLECTION =====
    // Members can read bookings from their clubs
    // Members can create bookings for themselves
    // Members can update/cancel their own bookings
    // Managers can manage all bookings
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // ===== HARVESTS COLLECTION =====
    // Members can read harvests from their clubs
    // Members can create their own harvests
    // Members can update/delete their own harvests
    match /harvests/{harvestId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ===== INVITES COLLECTION =====
    // Invitees and managers can read invites
    // Managers can create invites
    // Managers can update/delete invites
    match /invites/{inviteId} {
      allow read: if isAuthenticated() &&
        (resource.data.email == request.auth.token.email ||
         isManagerOrOwner(resource.data.clubId));

      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);

      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    // ===== PROPERTY/MAP DATA =====
    // Members can read property data from their clubs
    // Managers can create/update/delete property data

    match /propertyBoundaries/{boundaryId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /foodPlots/{plotId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /accessRoutes/{routeId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /terrainFeatures/{featureId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /trailCameras/{cameraId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    // ===== PHASE 5: ACTIVITY FEED & COMMUNICATION =====

    // POSTS - Members can read posts from their clubs
    // Members can create posts
    // Members can edit/delete their own posts
    // Managers can pin/unpin announcements
    match /posts/{postId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId) &&
        // Only managers can create announcements
        (request.resource.data.type != 'announcement' ||
         isManagerOrOwner(request.resource.data.clubId));

      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         // Managers can pin/unpin any post
         isManagerOrOwner(resource.data.clubId));

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // COMMENTS - Members can read comments from their clubs
    // Members can create/edit/delete their own comments
    match /comments/{commentId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // REACTIONS - Members can read/create/delete reactions
    // Users can only manage their own reactions
    match /reactions/{reactionId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // EVENTS - Members can read events from their clubs
    // Managers can create/update/delete events
    match /events/{eventId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        isManagerOrOwner(request.resource.data.clubId);

      allow update, delete: if isAuthenticated() &&
        (resource.data.createdBy == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // EVENT RSVPs - Members can read/create/update their own RSVPs
    match /eventRSVPs/{rsvpId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // ===== DEFAULT DENY =====
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
