rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is a system-wide super admin
    function isSuperAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }

    // Check if user is an ACTIVE and APPROVED member of the club
    // This ensures pending, rejected, or suspended members cannot access club data
    function isMember(clubId) {
      let membershipPath = /databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid);
      return isAuthenticated() &&
        exists(membershipPath) &&
        get(membershipPath).data.membershipStatus == 'active' &&
        get(membershipPath).data.approvalStatus == 'approved';
    }

    // Check if user has owner or manager role in the club (must be active & approved)
    function isManagerOrOwner(clubId) {
      let membershipPath = /databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid);
      return isAuthenticated() &&
        exists(membershipPath) &&
        get(membershipPath).data.role in ['owner', 'manager'] &&
        get(membershipPath).data.membershipStatus == 'active' &&
        get(membershipPath).data.approvalStatus == 'approved';
    }

    // Check if user is owner of the club (must be active & approved)
    function isClubOwner(clubId) {
      let membershipPath = /databases/$(database)/documents/clubMemberships/$(clubId + '_' + request.auth.uid);
      return isAuthenticated() &&
        exists(membershipPath) &&
        get(membershipPath).data.role == 'owner' &&
        get(membershipPath).data.membershipStatus == 'active' &&
        get(membershipPath).data.approvalStatus == 'approved';
    }

    // ===== USERS COLLECTION =====
    // Users can read any profile (for member discovery, invites, etc.)
    // Users can create their own profile
    // Users can only update their own profile (basic fields)
    // ClubIds array is managed by club join/leave operations
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin()) &&
        // Prevent regular users from directly modifying isSuperAdmin, isBanned
        (isSuperAdmin() || 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isSuperAdmin', 'isBanned']));
      allow delete: if isSuperAdmin();
    }

    // ===== CLUBS COLLECTION =====
    // Anyone can read public clubs (for discovery)
    // Members can read their own clubs
    // Anyone can create a club (they become owner)
    // Only owner can update or delete
    match /clubs/{clubId} {
      allow read: if resource.data.isPublic == true || isMember(clubId) || isSuperAdmin();
      allow create: if isAuthenticated() &&
        (request.resource.data.ownerId == request.auth.uid || isSuperAdmin());
      allow update: if isClubOwner(clubId) || isSuperAdmin();
      allow delete: if isClubOwner(clubId) || isSuperAdmin();
    }

    // ===== CLUB MEMBERSHIPS COLLECTION =====
    // Active members can read all memberships for their clubs
    // Users can always read their own membership (to check status)
    // System creates memberships (via cloud functions or app logic)
    // Managers can update member roles/status
    // Managers can delete memberships (remove members)
    match /clubMemberships/{membershipId} {
      // Allow reading own memberships (even pending) or memberships from clubs where user is active member
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isMember(resource.data.clubId) ||
         isSuperAdmin());

      // Can create if: creating own membership OR manager adding member OR creating owner membership for your club
      allow create: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid ||
         isManagerOrOwner(request.resource.data.clubId) ||
         (request.resource.data.role == 'owner' &&
          get(/databases/$(database)/documents/clubs/$(request.resource.data.clubId)).data.ownerId == request.auth.uid));

      // Managers can update (change roles, status)
      // Users can update their own basic fields (not role/status)
      allow update: if isManagerOrOwner(resource.data.clubId) ||
        (request.auth.uid == resource.data.userId &&
         request.resource.data.role == resource.data.role &&
         request.resource.data.membershipStatus == resource.data.membershipStatus);

      // Only managers can remove members
      allow delete: if isManagerOrOwner(resource.data.clubId);
    }

    // ===== CLUB JOIN REQUESTS COLLECTION =====
    // Users can read their own requests
    // Managers can read requests for their club
    // Users can create requests for public clubs
    // Managers can update (approve/reject)
    // Users can cancel their own requests
    match /clubJoinRequests/{requestId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isManagerOrOwner(resource.data.clubId) ||
        (request.auth.uid == resource.data.userId &&
         request.resource.data.status == 'cancelled');

      allow delete: if isManagerOrOwner(resource.data.clubId);
    }

    // ===== STANDS COLLECTION =====
    // Members can read stands from their clubs
    // Managers can create/update/delete stands
    match /stands/{standId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    // ===== BOOKINGS COLLECTION =====
    // Members can read bookings from their clubs
    // Members can create bookings for themselves
    // Members can update/cancel their own bookings
    // Managers can manage all bookings
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        (isMember(request.resource.data.clubId) || isSuperAdmin());

      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // ===== HARVESTS COLLECTION =====
    // Members can read harvests from their clubs
    // Members can create their own harvests
    // Members can update their own harvests
    // Members can delete their own harvests, managers can delete any for moderation
    match /harvests/{harvestId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // ===== INVITES COLLECTION =====
    // Invitees and managers can read invites
    // Managers can create invites
    // Managers can update/delete invites
    match /invites/{inviteId} {
      allow read: if isAuthenticated() &&
        (resource.data.email == request.auth.token.email ||
         isManagerOrOwner(resource.data.clubId));

      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);

      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    // ===== PROPERTY/MAP DATA =====
    // Members can read property data from their clubs
    // Managers can create/update/delete property data

    match /propertyBoundaries/{boundaryId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /foodPlots/{plotId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /accessRoutes/{routeId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /terrainFeatures/{featureId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    match /trailCameras/{cameraId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);
      allow create: if isAuthenticated() &&
        isManagerOrOwner(request.resource.data.clubId);
      allow update, delete: if isAuthenticated() &&
        isManagerOrOwner(resource.data.clubId);
    }

    // ===== PHASE 5: ACTIVITY FEED & COMMUNICATION =====

    // POSTS - Members can read posts from their clubs
    // Members can create posts
    // Members can edit/delete their own posts
    // Managers can pin/unpin announcements
    match /posts/{postId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId) &&
        // Only managers can create announcements
        (request.resource.data.type != 'announcement' ||
         isManagerOrOwner(request.resource.data.clubId));

      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId) ||
         (isMember(resource.data.clubId) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount', 'reactions'])));

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // COMMENTS - Members can read comments from their clubs
    // Members can create/edit their own comments
    // Members can delete their own comments, managers can delete any comment for moderation
    match /comments/{commentId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // REACTIONS - Members can read/create/delete reactions
    // Users can only manage their own reactions
    match /reactions/{reactionId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // EVENTS - Members can read events from their clubs
    // Managers can create/update/delete events
    match /events/{eventId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        isManagerOrOwner(request.resource.data.clubId);

      allow update, delete: if isAuthenticated() &&
        (resource.data.createdBy == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // EVENT RSVPs - Members can read/create/update their own RSVPs
    match /eventRSVPs/{rsvpId} {
      allow read: if isAuthenticated() && isMember(resource.data.clubId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        isMember(request.resource.data.clubId);

      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isManagerOrOwner(resource.data.clubId));
    }

    // REPORTS - Members can create reports
    // Managers can read and update reports for their club
    // Superadmins can manage all reports
    match /reports/{reportId} {
      allow read: if isAuthenticated() && (isManagerOrOwner(resource.data.clubId) || isSuperAdmin());
      
      allow create: if isAuthenticated() && 
        request.resource.data.reporterId == request.auth.uid &&
        (isMember(request.resource.data.clubId) || isSuperAdmin());
        
      allow update: if isAuthenticated() && (isManagerOrOwner(resource.data.clubId) || isSuperAdmin());
      
      allow delete: if isSuperAdmin();
    }

    // ===== DEFAULT DENY =====
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
